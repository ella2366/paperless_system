{% extends 'sender/base.html' %}
{% block content %}

{% csrf_token %}

<style>
    /* Custom styles para sa Notification Dropdown */
    .notification-dropdown { 
        width: 320px; 
        max-height: 400px; 
        overflow-y: auto; 
        border-radius: 12px; 
        border: none;
    }
    .notif-item { 
        transition: background 0.2s; 
        border-bottom: 1px solid #f1f5f9; 
    }
    .notif-item:hover { 
        background-color: #f8fafc; 
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-5">
    <div>
        <h1 class="fw-bold mb-0">Welcome Back, {{ request.user.username }}!</h1>
        <div class="d-flex align-items-center gap-3 mt-2">
            {% if request.user.is_verified %}
                <span class="badge bg-success-subtle text-success border border-success-subtle px-3 py-2">
                    <i class="bi bi-shield-check me-1"></i> 2FA Secured
                </span>
            {% else %}
                <a href="{% url 'two_factor:setup' %}" class="badge bg-warning-subtle text-warning border border-warning-subtle px-3 py-2 text-decoration-none">
                    <i class="bi bi-shield-exclamation me-1"></i> Enable 2FA Security
                </a>
            {% endif %}

            <div class="dropdown">
                <button class="btn btn-light position-relative rounded-circle p-2 shadow-sm" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-bell-fill text-primary fs-5"></i>
                    {% if total_notifications > 0 %}
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger border border-light" id="mainNotifBadge">
                            {{ total_notifications }}
                        </span>
                    {% endif %}
                </button>
                <div class="dropdown-menu dropdown-menu-end shadow-lg notification-dropdown p-0">
                    <div class="p-3 border-bottom bg-light">
                        <h6 class="mb-0 fw-bold">Notifications</h6>
                    </div>
                    
                    <a href="#" onclick="toggleChat()" class="dropdown-item notif-item p-3 d-flex align-items-center">
                        <div class="bg-primary-subtle p-2 rounded-circle me-3">
                            <i class="bi bi-chat-text text-primary"></i>
                        </div>
                        <div class="flex-grow-1">
                            <p class="mb-0 small fw-bold">Messenger</p>
                            <small class="text-muted">You have {{ unread_chats }} new messages</small>
                        </div>
                        {% if unread_chats > 0 %}
                            <span class="badge bg-primary rounded-pill">{{ unread_chats }}</span>
                        {% endif %}
                    </a>

                    <a href="{% url 'inbox' %}" class="dropdown-item notif-item p-3 d-flex align-items-center">
                        <div class="bg-warning-subtle p-2 rounded-circle me-3">
                            <i class="bi bi-file-earmark-text text-warning"></i>
                        </div>
                        <div class="flex-grow-1">
                            <p class="mb-0 small fw-bold">Document Requests</p>
                            <small class="text-muted">{{ pending_notifs }} pending for review</small>
                        </div>
                        {% if pending_notifs > 0 %}
                            <span class="badge bg-warning text-dark rounded-pill">{{ pending_notifs }}</span>
                        {% endif %}
                    </a>

                    {% if total_notifications == 0 %}
                        <div class="p-4 text-center">
                            <i class="bi bi-check2-circle text-success display-6 opacity-25"></i>
                            <p class="small text-muted mt-2 mb-0">No new notifications</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <button type="button" class="btn btn-primary fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#uploadModal">
        <i class="bi bi-plus-lg me-2"></i>New Request
    </button>
</div>

<div class="row g-4 mb-5">
    <div class="col-md-9">
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card p-4 border-start border-primary border-5 h-100 shadow-sm">
                    <h6 class="text-uppercase text-muted small fw-bold">Incoming for Review</h6>
                    <h2 class="fw-bold mb-0">{{ received_count }}</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-4 border-start border-success border-5 h-100 shadow-sm">
                    <h6 class="text-uppercase text-muted small fw-bold">Successfully Signed</h6>
                    <h2 class="fw-bold mb-0">{{ sent_count }}</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-4 border-start border-danger border-5 h-100 shadow-sm">
                    <h6 class="text-uppercase text-muted small fw-bold">For Revision (Declined)</h6>
                    <h2 class="fw-bold mb-0">{{ rejected_count }}</h2>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card p-3 shadow-sm h-100 d-flex flex-column align-items-center justify-content-center text-center">
            <h6 class="text-uppercase text-muted small fw-bold mb-3">Analytics Overview</h6>
            <canvas id="docAnalyticsChart" style="max-height: 120px; max-width: 120px;"></canvas>
        </div>
    </div>
</div>

<div class="card p-4 shadow-sm">
    <h5 class="fw-bold mb-4"><i class="bi bi-clock-history me-2"></i>Recent Documents</h5>
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Title</th>
                    <th>User Info</th>
                    <th>Status</th>
                    <th class="text-end">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for doc in all_documents %}
                <tr>
                    <td><span class="fw-semibold text-primary">{{ doc.title }}</span></td>
                    <td>
                        <small class="text-muted">
                            {% if doc.sender == request.user %}
                                <i class="bi bi-arrow-up-right me-1 text-info"></i>To: {{ doc.receiver.username }}
                            {% else %}
                                <i class="bi bi-arrow-down-left me-1 text-warning"></i>From: {{ doc.sender.username }}
                            {% endif %}
                        </small>
                    </td>
                    <td>
                        {% if doc.status == 'pending' %}
                            <span class="badge bg-warning-subtle text-warning px-3 py-2 border border-warning-subtle">Pending Review</span>
                        {% elif doc.status == 'approved' %}
                            <span class="badge bg-success-subtle text-success px-3 py-2 border border-success-subtle">Approved</span>
                        {% elif doc.status == 'rejected' %}
                            <span class="badge bg-danger-subtle text-danger px-3 py-2 border border-danger-subtle">Declined</span>
                        {% endif %}
                    </td>
                    <td class="text-end">
                        <div class="d-flex gap-2 justify-content-end align-items-center">
                            <button type="button" class="btn btn-sm btn-outline-primary px-3 rounded-pill" 
                                    data-bs-toggle="modal" data-bs-target="#viewModal{{ doc.id }}">
                                View
                            </button>
                            {% if doc.status != 'pending' %}
                            <button type="button" class="btn btn-sm btn-outline-secondary rounded-circle shadow-sm" 
                                    data-bs-toggle="modal" data-bs-target="#archiveModal{{ doc.id }}"
                                    style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-archive"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="text-center py-5 text-muted">No documents found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<button class="btn btn-primary rounded-circle shadow-lg" onclick="toggleChat()" 
    style="position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; z-index: 1050;">
    <i class="bi bi-chat-dots-fill fs-4"></i>
</button>

<div id="chatWindow" class="card shadow-lg border-0 d-none" 
    style="position: fixed; bottom: 100px; right: 30px; width: 350px; height: 450px; z-index: 1050; border-radius: 15px;">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center p-3" style="border-radius: 15px 15px 0 0;">
        <h6 class="mb-0 fw-bold"><i class="bi bi-chat-fill me-2"></i>TUD Messenger</h6>
        <button type="button" class="btn-close btn-close-white" onclick="toggleChat()"></button>
    </div>
    
    <div class="p-2 border-bottom bg-light">
        <select id="receiverSelect" class="form-select form-select-sm border-0 bg-light">
            <option value="" selected disabled>Select contact...</option>
            {% for user in all_users %}
                <option value="{{ user.id }}">{{ user.username }}</option>
            {% endfor %}
        </select>
    </div>

    <div id="chatContent" class="card-body overflow-auto p-3" style="background-color: #f8fafc; height: 250px;">
        <div class="text-center text-muted mt-5 py-5">
            <i class="bi bi-chat-left-dots display-4 opacity-25"></i>
            <p class="small">Pumili ng kausap para mag-simula.</p>
        </div>
    </div>

    <div class="card-footer bg-white border-0 p-3">
        <form id="chatForm" class="input-group">
            <input type="text" id="messageInput" class="form-control border-light bg-light shadow-none" placeholder="Type a message...">
            <button class="btn btn-primary" type="submit"><i class="bi bi-send"></i></button>
        </form>
    </div>
</div>

{% for doc in all_documents %}
    <div class="modal fade" id="viewModal{{ doc.id }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">Document Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Title:</strong> {{ doc.title }}</p>
                    <p><strong>Status:</strong> {{ doc.status|title }}</p>
                </div>
                <div class="modal-footer border-0">
                    <a href="{% url 'review_document' doc.id %}" class="btn btn-primary w-100">Open Review</a>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="archiveModal{{ doc.id }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content text-center border-0 shadow">
                <div class="modal-body p-4">
                    <i class="bi bi-archive-fill text-danger display-4 mb-3"></i>
                    <h5 class="fw-bold">Archive This?</h5>
                    <p class="text-muted small">Ang document na <strong>{{ doc.title }}</strong> ay ililipat sa archives list.</p>
                    <div class="d-flex gap-2 mt-4">
                        <button type="button" class="btn btn-light flex-grow-1" data-bs-dismiss="modal">Cancel</button>
                        <form action="{% url 'archive_document' doc.id %}" method="POST" class="flex-grow-1">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger w-100 fw-bold">Confirm</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endfor %}

<div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">New Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-4">
                <div class="bg-primary-subtle rounded-circle p-4 d-inline-block mb-3">
                    <i class="bi bi-cloud-arrow-up text-primary h1"></i>
                </div>
                <p class="text-muted">Create a new paperless transaction.</p>
                <a href="{% url 'upload_document' %}" class="btn btn-primary fw-bold w-100 py-2 shadow-sm">Proceed to Upload</a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const currentUser = "{{ request.user.username }}";

    // --- Analytics Chart ---
    const ctx = document.getElementById('docAnalyticsChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Pending', 'Signed', 'Declined'],
            datasets: [{
                data: [{{ received_count|default:0 }}, {{ sent_count|default:0 }}, {{ rejected_count|default:0 }}],
                backgroundColor: ['#2563eb', '#10b981', '#ef4444'],
                borderWidth: 0
            }]
        },
        options: { cutout: '75%', plugins: { legend: { display: false } } }
    });

    // --- Chat Functions ---
    function toggleChat() {
        document.getElementById('chatWindow').classList.toggle('d-none');
        // Optional: Kapag binuksan ang chat, itago muna ang badge kung gusto mo
        // document.getElementById('mainNotifBadge').style.display = 'none';
    }

    document.getElementById('chatForm').onsubmit = function(e) {
        e.preventDefault();
        const receiverId = document.getElementById('receiverSelect').value;
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        if (!receiverId || !message.trim()) return;

        fetch('/sender/send-chat/', { // Alisin ang /sender/ prefix
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 'receiver_id': receiverId, 'message': message })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                messageInput.value = '';
                loadMessages();
            }
        })
        .catch(err => console.error('Send Error:', err));
    };

    function loadMessages() {
        const receiverId = document.getElementById('receiverSelect').value;
        if (!receiverId) return;

       fetch(`/sender/get-messages/${receiverId}/`) // Dagdagan ng /sender/
    .then(response => response.json())
            .then(data => {
                const chatContent = document.getElementById('chatContent');
                if (data.messages) {
                    chatContent.innerHTML = data.messages.map(msg => `
                        <div class="mb-3 ${msg.sender === currentUser ? 'text-end' : ''}">
                            <div class="d-inline-block p-2 px-3 rounded shadow-sm small ${msg.sender === currentUser ? 'bg-primary text-white' : 'bg-white text-dark'}" 
                                 style="max-width: 85%; border-radius: 15px !important;">
                                ${msg.content}
                            </div>
                            <div style="font-size: 10px;" class="text-muted mt-1 px-1">${msg.time}</div>
                        </div>
                    `).join('');
                    chatContent.scrollTop = chatContent.scrollHeight;
                }
            })
            .catch(err => console.error('Load Error:', err));
    }

    setInterval(loadMessages, 3000);
    document.getElementById('receiverSelect').onchange = loadMessages;
</script>

{% endblock %}